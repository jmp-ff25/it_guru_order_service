# Используем официальный образ Python
FROM python:3.11-alpine3.19

# Установите основные переменные окружения
ENV APP_HOME=/home/app/
ENV WORKDIR_ITGURU_BACKEND=/home/app/project_itguru

# create directory for the app user
RUN mkdir -p $WORKDIR_ITGURU_BACKEND/app

# create the app user
RUN addgroup -S app && adduser -S app -G app
RUN chown -R app:app $APP_HOME

# Устанавливаем рабочую директорию в контейнере
WORKDIR $WORKDIR_ITGURU_BACKEND

# Отключаем кэширование pyc-файлов и буферизацию вывода Python
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Установим системные зависимости для сборки Python-библиотек
RUN apk add --no-cache \
    gcc \
    musl-dev \
    python3-dev \
    libffi-dev \
    make

# Установим зависимости из requirements.txt
ARG REQ_FILE
COPY ./app/requirements.txt $WORKDIR_ITGURU_BACKEND

RUN pip install --default-timeout=100 --upgrade pip
RUN pip install --default-timeout=100 --no-cache-dir -r requirements.txt

# Копируем проект в рабочую директорию контейнера
COPY ./app/* $WORKDIR_ITGURU_BACKEND/app
# Копируем конфигурацию Alembic
COPY ./alembic.ini $WORKDIR_ITGURU_BACKEND
# Добавляем alias в .bashrc для пользователя root (или для другого пользователя, если требуется)
RUN echo "alias alembic-autogen='alembic revision --autogenerate -m \"Autogenerated migration $(date +%Y-%m-%d_%H:%M:%S)\" && alembic upgrade head'" >> /root/.bashrc


# Указываем порт, который будет использовать приложение
EXPOSE 8000